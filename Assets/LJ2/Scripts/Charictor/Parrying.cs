using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class Parrying : MonoBehaviour
{
    [SerializeField] bool isParrying = false;
    [SerializeField] float parryRadius = 1.1f;
    [SerializeField, HideInInspector] LayerMask enemyBullet;
    [SerializeField] Collider characterCollider;

    private Coroutine parryCoroutine;
    public YieldInstruction coroutineDelay;
    [SerializeField] float invincibleTime = 1;

    [SerializeField] int shield = 3;

    private Transform invincibleTransform;
    [SerializeField] public GameObject invinciblePrefab;

    public void Awake()
    {
        characterCollider = GetComponent<Collider>();
        coroutineDelay = new WaitForSeconds(invincibleTime);
        enemyBullet = LayerMask.GetMask("EnemyBullet");
        invinciblePrefab = transform.Find("InvincibleShield").gameObject;
    }

    public void Parry()
    {
        Collider[] canParry = Physics.OverlapSphere(transform.position, parryRadius, enemyBullet);
        Debug.Log($"패리 가능 오브젝트 수 : {canParry.Length}");
        if (canParry.Length > 0)
        {
            isParrying = true;

            foreach (Collider c in canParry)
            {
                Debug.Log($"{c.gameObject.name} 패리 충돌체 이름");
                c.gameObject.SetActive(false); // Deactivate enemy bullets
            }
        }
        else
        {
            isParrying = false; // No bullets to parry
        }
    }

    public void Invicible()
    {   
        if (isParrying)
        {
           parryCoroutine = StartCoroutine(InvincibleCoroutine());
        }
        isParrying = false; // Reset parrying state
    }


    private IEnumerator InvincibleCoroutine()
    {
        Debug.Log("코루틴 진입");

        invinciblePrefab.SetActive(true);
        yield return coroutineDelay;

        invinciblePrefab.SetActive(false);
        parryCoroutine = null;
        yield break;

    }

    public int Shield()
    {
        int getShield = 0; // Default shield value
        if (isParrying)
        {
            getShield = shield;
        }
        isParrying = false; // Reset parrying state after getting shield
        return getShield;
    }

    // 반사된 총알을 적에게 발사하는 기능은 현재 구현되어 있지 않습니다.
    private void OnDrawGizmosSelected()
    {
        Gizmos.color = Color.red;
        Gizmos.DrawWireSphere(transform.position, parryRadius);
    }
}
